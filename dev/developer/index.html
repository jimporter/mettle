<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Developer Guide - mettle</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/color-brewer.min.css">
        <link href="../css/extra.css" rel="stylesheet">
        <link href="../css/version-select.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="..">mettle</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="..">Home</a>
                            </li>
                            <li >
                                <a href="../install/">Installation</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">User Guide <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../tutorial/">Tutorial</a>
</li>
                                    
<li >
    <a href="../running-tests/">Running Tests</a>
</li>
                                    
<li >
    <a href="../writing-tests/">Writing Tests</a>
</li>
                                    
<li >
    <a href="../expectations/">Expectations</a>
</li>
                                    
<li >
    <a href="../built-in-matchers/">Built-in Matchers</a>
</li>
                                    
<li >
    <a href="../writing-matchers/">Writing Your Own Matchers</a>
</li>
                                </ul>
                            </li>
                            <li class="active">
                                <a href="./">Developer Guide</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../about/changes/">Changes</a>
</li>
                                    
<li >
    <a href="../about/license/">License</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../writing-matchers/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../about/changes/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/jimporter/mettle/"><i class="fa fa-github"></i> GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#developer-guide">Developer Guide</a></li>
            <li><a href="#runner">Runner</a></li>
            <li><a href="#suites">Suites</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="developer-guide">Developer Guide<a class="headerlink" href="#developer-guide" title="Permanent link">§</a></h1>
<p>If you're looking to learn about how mettle actually works, you've come to the
right place! This developer guide will describe mettle's internals and how
everything fits together.</p>
<h2 id="runner">Runner<a class="headerlink" href="#runner" title="Permanent link">§</a></h2>
<p>mettle's structure is a bit different from other test frameworks. First, like
some other test frameworks, individual (user-written) test files link to a
shared library (<code>libmettle.so</code> / <code>mettle.dll</code>) to pull in common driver code.</p>
<p>However, in addition, the <code>mettle</code> test driver can be used to aggregate the
results of multiple test files. This lets you put your tests into multiple,
separate binaries to reduce compilation time and allow different kinds of tests
to be run all at once (e.g. normal unit tests and compilation-failure tests).</p>
<h3 id="subprocesses">Subprocesses<a class="headerlink" href="#subprocesses" title="Permanent link">§</a></h3>
<p>When running tests, mettle makes extensive use of subprocesses to isolate tests
as much as possible. First, the <code>mettle</code> driver creates a subprocess for each
individual test binary, and these in turn (by default) create a subprocess for
each test in the file. This ensures that no one test can crash the entire
framework. However, the particulars differ between POSIX systems and Windows.</p>
<h4 id="posix">POSIX<a class="headerlink" href="#posix" title="Permanent link">§</a></h4>
<p>When the individual test binary forks for a specific test, the <em>test process</em> is
also set as the process group leader for a new process group. This ensures
that any subprocesses it spawns can be killed after the main process finishes.</p>
<p>Additionally, if tests are set to time out after a certain period, two more
subprocesses are forked for each test: a <em>monitor process</em> and a <em>timer
process</em>. The monitor process forks both the timer process and the actual test
process and waits for the first one to finish. The timer process automatically
exits after the timeout expires, and if it exits before the test process, the
monitor process kills the test and sends a message that it timed out.</p>
<p>You might be thinking, "why not just use <code>alarm(2)</code> or <code>setitimer(2)</code> instead of
forking two extra times?" However, this would interact poorly with tests that
rely on functions like <code>sleep(3)</code>. Hence, in the interest of maximum isolation
of the test code, the timer is implemented as a subprocess. Likewise, running
the timer in the parent process requires greater care when handling signals. In
any case, the current method has the significant benefit of being entirely
transparent to the parent process.</p>
<h4 id="windows">Windows<a class="headerlink" href="#windows" title="Permanent link">§</a></h4>
<p>Since Windows is unable to fork a process, when the individual test binary
creates a subprocess for a test, it simply reruns itself with a different set of
command-line arguments, indicating that only a specific test should be run. This
subprocess is immediately placed into a new job, ensuring that – like the POSIX
version's process groups – any subprocesses it spawns can be killed after the
main process finishes.</p>
<p>Unlike the POSIX version, if tests are set to time out, we simply create a timer
event and wait for it while we're waiting for the test process to end. If the
timer's event fires first, we know to kill the test process. Since the timer is
run in the parent process, this provides the same level of isolation as the
POSIX version, but at the expense of some extra management; the parent process
must now pay specific attention to the timer event instead of assuming that its
child process will handle it.</p>
<h2 id="suites">Suites<a class="headerlink" href="#suites" title="Permanent link">§</a></h2>
<p>When creating a test suite, the most important argument to pass is the <em>creation
function</em> (conventionally a generic lambda). This function takes a
<code>suite_builder</code> (or a <code>subsuite_builder</code> for subsuites). These are both template
classes that let the user add tests or subsuites to the given suite.</p>
<p>Once the creation function returns, the suite is compiled into a
<code>runnable_suite</code> (subsuites, however, are merely compiled into an intermediary
form and stored in its parent's <code>(sub)suite_builder</code> instance). When the parent
is compiled, the subsuite and all of its tests are compiled as well, until it
gets to the root suite, at which point all tests and subsuites are
fully-compiled.</p>
<p>If using the global <code>suite</code> or <code>basic_suite</code> types, once the suite is
fully-compiled, it gets added to a global list of suites, held in
<code>detail::all_suites()</code> (subsuites, however, are contained within their parents).
This list is then used by the test driver to run all the tests.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2014-2022 Jim Porter</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../js/version-select.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
